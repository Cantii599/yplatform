variables:
  FORCE_UNSAFE_CONFIGURE: "1"
  GIT_SUBMODULE_STRATEGY: recursive
  SF_CI_BREW_INSTALL: minimal
  SF_LOG_BOOTSTRAP: "true"

.aliases:
  - &shared
    image:
      # name: ubuntu:18.04
      # NOTE using the prebuilt docker image of homebrew (linuxbrew)
      # because homebrew cannot be installed as root,
      # and creating a sudoer user and then running gitlab jobs through it failed
      name: homebrew/ubuntu18.04:3.2.8
    only:
      - /^gitlab/ # gitlab branches
      - master
      # - /^v(\d+)\.(\d+)\.(\d+)/ # version tags
    cache:
      key: ${CI_COMMIT_REF_SLUG}
      paths:
        # common
        - $HOME/.local
        - $HOME/.npm
        # darwin
        - $HOME/.homebrew
        - $HOME/Library/Caches/Homebrew
        - $HOME/Library/Caches/pip
        # linux
        - $HOME/.cache/Homebrew
        - $HOME/.cache/pip
        - $HOME/.linuxbrew


main_job:
  <<: *shared
  script:
    - |
      set -euo pipefail
      sudo chown -R $(id -u):$(id -g) ${CI_PROJECT_DIR}
      cd ${CI_PROJECT_DIR}
      source ci/pipeline.script.sh
