#!/usr/bin/env bash
(set -o igncr) 2>/dev/null && set -o igncr; # Magic to make it work under cygwin

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TOP="$(cd ${DIR}/../.. && pwd)"
source ${TOP}/support/sh/common.inc.sh

#- ci_echo 1.0
## Usage: ci_echo STEP TEXT...
## Echo message with a STEP indicator for stdout or for TeamCity consumption.
##
##   -h, --help     Display this help and exit
##   -v, --version  Output version information and exit

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            sh_script_usage
            ;;
        -v|--version)
            sh_script_version
            ;;
        -* )
            usage
            ;;
        *)
            break
            ;;
    esac
done

[ "${CI:-}" = true ] || {
    >&2 echo "$@"
    exit 0
}

STATUS=NORMAL
MESSAGE="$(echo "${@:2}" | sed "s/'/|'/")"

case $1 in
    "[NEXT]")
        echo "##teamcity[progressMessage '${MESSAGE}']"
        exit 0
    ;;
    "[DO  ]")
        echo "##teamcity[blockOpened name='$(pwd)' description='${MESSAGE}']"
        exit 0
    ;;
    "[DONE]")
        echo "##teamcity[blockClosed name='$(pwd)']"
        exit 0
    ;;
    "[SKIP]")
        STATUS=WARNING
    ;;
    "[WARN]")
        STATUS=WARNING
    ;;
    "[ERR ]")
        STATUS=ERROR
    ;;
    "[INFO]"|*)
    ;;
esac

echo "##teamcity[message text='${MESSAGE}' status='${STATUS}']"
