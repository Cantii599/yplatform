#!/usr/bin/env node -r babel-register

import AWS_ACCOUNT from 'aws-cfn-util-firecloud/lib/const/aws-account';
import _ from 'lodash';
import aws from 'aws-sdk';
import env from 'aws-cfn-util-firecloud/lib/env';
import {
  getDomain as getApiDomain
} from 'aws-cfn-util-firecloud/lib/env-api';
import {
  getBucketName
} from 'aws-cfn-util-firecloud/lib/aws-s3';

let main = async function({env, cmd}) {
  let apigateway = new aws.APIGateway({
    region: env.AWS_REGION
  });

  let domainName = getApiDomain({env});

  if (cmd === 'create') {
    try {
      await apigateway.getDomainName({
        domainName
      }).promise();
    } catch (err) {
      if (err.code !== 'NotFoundException') {
        throw err;
      }

      await exports.createDomainName({
        env,
        domainName
      });
    }
  } else if (cmd === 'delete') {
    await apigateway.deleteDomainName({
      domainName
    }).promise();
  }
};

exports.createDomainName = async function({env}) {
  let domainName = getApiDomain({env});
  let configBucketName = getBucketName({
    env,
    prefix: 'config'
  });

  let apigateway = new aws.APIGateway({
    region: env.AWS_REGION
  });

  let iam = new aws.IAM({
    region: env.AWS_REGION
  });

  let s3 = new aws.S3({
    region: env.AWS_REGION,
    signatureVersion: 'v4'
  });

  let certificatePrivateKey = (await s3.getObject({
    Bucket: configBucketName,
    Key: `cert/${AWS_ACCOUNT.CERT_NAME}.private.pem`
  }).promise()).Body.toString();

  let {
    CertificateBody,
    CertificateChain
  } = (await iam.getServerCertificate({
    ServerCertificateName: AWS_ACCOUNT.CERT_NAME
  }).promise()).ServerCertificate;

  console.log(`Creating API Gateway Domain Name ${domainName}...`);
  await apigateway.createDomainName({
    certificateBody: CertificateBody,
    certificateChain: CertificateChain,
    certificateName: AWS_ACCOUNT.CERT_NAME,
    certificatePrivateKey,
    domainName
  }).promise();
  console.log(`Done creating API Gateway Domain Name ${domainName}.`);
};

export default main;

(async function() {
  if (!module.parent) {
    await main({
      env,
      cmd: process.argv[2]
    });
  }
})();
