#!/usr/bin/env bash
set -euo pipefail

SUPPORT_FIRECLOUD_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
source ${SUPPORT_FIRECLOUD_DIR}/sh/common.inc.sh

${SUPPORT_FIRECLOUD_DIR}/ci/linux/bootstrap-sudo

MEM_MIB=$(free -m | grep Mem | sed "s/ \+/ /g" | cut -d" " -f2)
MEM_GIB=$(( (${MEM_MIB}*2 + 1023) / 1024 ))
MEM_GIB_SWAP=/mnt/${MEM_GIB}GiB.swap
(
    echo_do "Enabling swap..."
    cat /proc/swaps
    sudo fallocate -l ${MEM_GIB}g ${MEM_GIB_SWAP}
    sudo chmod 600 ${MEM_GIB_SWAP}
    sudo mkswap ${MEM_GIB_SWAP}
    sudo swapon ${MEM_GIB_SWAP}
    echo_done
)


source ${SUPPORT_FIRECLOUD_DIR}/ci/brew-bootstrap.inc.sh
brew_brewfile_inc_sh
brew_list

(
    echo_do "Disabling swap..."
    sudo swapoff ${MEM_GIB_SWAP}
    sudo rm ${MEM_GIB_SWAP}
    echo_done
)

[[ "${CI:-}" != "true" ]] || {
    echo_do "Printenv..."
    printenv
    echo_done
}

# see https://github.com/Homebrew/brew/issues/5013
hash -r
