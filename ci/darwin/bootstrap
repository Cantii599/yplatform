#!/usr/bin/env bash
set -euo pipefail

echo "Installing/Upgrading homebrew..."
ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" || \
    true # fails if already installed
brew update
brew outdated
brew upgrade

echo "Installing/Upgrading git..."
brew list git >/dev/null 2>&1 || brew install git
brew outdated git >/dev/null 2>&1 || brew upgrade git

# ------------------------------------------------------------------------------

SUPPORT_FIRECLOUD_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
source ${SUPPORT_FIRECLOUD_DIR}/bin/common.inc.sh

brew_install() {
    echo "$@" | while read FORMULA; do
        NAME=$(echo "${FORMULA}" | cut -d' ' -f1)
        brew list "${NAME}" >/dev/null 2>&1 || brew install ${FORMULA}
    done
}

# Basic/GNU
echo_do "Installing basic/GNU packages..."
BREW_FORMULAE="$(cat <<-EOF
autoconf
automake
coreutils
diffutils
findutils --with-default-names
gnu-sed --with-default-names
gnu-tar --with-default-names
gnu-time --with-default-names
gnu-which
grep --with-default-names
gzip
make --with-default-names
parallel
pkg-config
unzip
watch
EOF
)"
brew_install "${BREW_FORMULAE}"
echo_done

# Misc
echo_do "Installing miscellaneous packages..."
BREW_FORMULAE="$(cat <<-EOF
bash
curl
git
jq
python@2
python@3
wget
EOF
)"
brew_install "${BREW_FORMULAE}"
brew link --force python@2
echo_done

# AWS
echo_do "Installing AWS utils..."
pip2 install --upgrade awscli
pip2 install --upgrade awslogs
aws configure set s3.signature_version s3v4
echo_done

echo_do "Printenv..."
printenv
echo_done

echo_do "Listing packages..."
brew list --versions
echo_done

# maybe NPM
if which npm >/dev/null 2>&1; then
    echo_do "Installing npm, json..."
    npm install --global npm
    npm install --global json
    echo_done
fi
