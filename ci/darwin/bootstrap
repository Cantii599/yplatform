#!/usr/bin/env bash
set -euo pipefail

sudo true || {
    >&2 echo "[ERROR] You need local admin rights to properly bootstrap." \
    "If you don't have local admin rights, try contacting the IT department."
    exit 1
}

SUPPORT_FIRECLOUD_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
source ${SUPPORT_FIRECLOUD_DIR}/sh/common.inc.sh

# improve date-time (ntp) sync
(
    sudo sntp -sS time.apple.com
) || true

brew_bootstrap_darwin() {
    local BREWFILE_INC_SH=${GIT_ROOT}/Brewfile.inc.sh
    [[ -f "${BREWFILE_INC_SH}" ]] || {
        echo_err "No ${BREWFILE_INC_SH} file present."
        return 1
    }
    source ${BREWFILE_INC_SH}
}

source ${SUPPORT_FIRECLOUD_DIR}/ci/brew-bootstrap.inc.sh
brew_bootstrap_darwin
brew_list

[[ "${CI:-}" != "true" ]] || {
    echo_do "Printenv..."
    printenv
    echo_done
}

# see https://github.com/Homebrew/brew/issues/5013
hash -r
